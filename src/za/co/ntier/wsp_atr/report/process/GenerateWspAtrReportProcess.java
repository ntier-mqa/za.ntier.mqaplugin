package za.co.ntier.wsp_atr.report.process;

import java.util.List;
import java.util.Properties;

import org.adempiere.exceptions.AdempiereException;
import org.adempiere.util.Callback;
import org.adempiere.webui.apps.BackgroundJob;
import org.compiere.model.MPInstance;
import org.compiere.model.MPInstancePara;
import org.compiere.model.MProcess;
import org.compiere.model.MTable;
import org.compiere.process.ProcessInfo;
import org.compiere.process.SvrProcess;
import org.compiere.util.DB;
import org.compiere.util.Env;

import za.co.ntier.wsp_atr.models.I_ZZ_WSP_ATR_Submitted;
import za.co.ntier.wsp_atr.models.X_ZZ_WSP_ATR_Report;
import za.ntier.models.MZZWSPATRSubmitted;

@org.adempiere.base.annotation.Process(
		name = "za.co.ntier.wsp_atr.report.process.GenerateWspAtrReportProcess")
public class GenerateWspAtrReportProcess extends SvrProcess {

	private int p_ZZ_WSP_ATR_Submitted_ID;
	private Properties ctx = null;
	private static final String PROCESS_PRINT_REPORT_UU = "0875c375-6e37-49fb-a5c0-798529189260";
	@Override
	protected void prepare() {
		p_ZZ_WSP_ATR_Submitted_ID = getRecord_ID();
		if (p_ZZ_WSP_ATR_Submitted_ID <= 0) {
			throw new IllegalArgumentException("No ZZ_WSP_ATR_Submitted record selected.");
		}
		ctx = getCtx();
	}

	@Override
	protected String doIt() throws Exception {


		// Load the submitted record (window record)
		MZZWSPATRSubmitted submitted =
				(MZZWSPATRSubmitted) MTable.get(getCtx(), I_ZZ_WSP_ATR_Submitted.Table_ID)
				.getPO(p_ZZ_WSP_ATR_Submitted_ID, get_TrxName());

		if (submitted == null) {
			throw new IllegalStateException("ZZ_WSP_ATR_Submitted not found for ID=" + p_ZZ_WSP_ATR_Submitted_ID);
		}

		// Step 1: try find existing report
		X_ZZ_WSP_ATR_Report report = findExistingReport(submitted);

		boolean isNewReport = false;

		if (report == null) {
		    // No existing report â†’ create and build
		    report = createReport(submitted);
		    isNewReport = true;
		}

		// Step 2: only build sections if this is a NEW report
		int totalInserted = 0;

		if (isNewReport) {
		    List<IReportSectionBuilder> builders =
		        ReportSectionBuilderFactory.getBuilders(getCtx(), submitted);

		    for (IReportSectionBuilder b : builders) {
		        ReportBuildResult r = b.build(report, submitted, get_TrxName());
		        totalInserted += r.getInsertedCount();
		        addLog("Section " + b.getSectionCode() +
		               " - " + b.getName() +
		               ": inserted " + r.getInsertedCount());
		    }
		}

		// Step 3: always print (existing or new)
		runProcessInBackgroundWithIntParam(
		    PROCESS_PRINT_REPORT_UU,
		    "ZZ_WSP_ATR_Report_ID",
		    report.getZZ_WSP_ATR_Report_ID(),
		    submitted.getZZ_WSP_ATR_Submitted_ID()
		);

		if (isNewReport) {
		    return "Created report ID=" + report.getZZ_WSP_ATR_Report_ID()
		            + " for submitted ID=" + p_ZZ_WSP_ATR_Submitted_ID
		            + ". Total inserted rows=" + totalInserted;
		} else {
		    return "Existing report ID=" + report.getZZ_WSP_ATR_Report_ID()
		            + " found. Report re-printed.";
		}
	}

	private X_ZZ_WSP_ATR_Report createReport(MZZWSPATRSubmitted submitted) {
		X_ZZ_WSP_ATR_Report report = new X_ZZ_WSP_ATR_Report(getCtx(), 0, get_TrxName());

		// Name/Description: make it meaningful for your users
		String name = "WSP/ATR Report - Submitted #" + submitted.getZZ_WSP_ATR_Submitted_ID();
		report.setName(name);
		report.setDescription("Generated by process on " + Env.getContextAsDate(getCtx(), "#Date"));

		report.setZZ_WSP_ATR_Submitted_ID(submitted.getZZ_WSP_ATR_Submitted_ID());

		// optionally set AD_Client_ID / AD_Org_ID explicitly if your table requires it
		// report.setAD_Org_ID(submitted.getAD_Org_ID());

		if (!report.save()) {
			throw new IllegalStateException("Failed to create ZZ_WSP_ATR_Report: "); // + report.getProcessMsg());
		}
		return report;
	}
	
	private X_ZZ_WSP_ATR_Report findExistingReport(MZZWSPATRSubmitted submitted) {

	    int submittedId = submitted.getZZ_WSP_ATR_Submitted_ID();

	    int existingReportId = DB.getSQLValueEx(
	        get_TrxName(),
	        "SELECT ZZ_WSP_ATR_Report_ID " +
	        "FROM ZZ_WSP_ATR_Report " +
	        "WHERE ZZ_WSP_ATR_Submitted_ID=? " +
	        "ORDER BY Created DESC, ZZ_WSP_ATR_Report_ID DESC " +
	        "FETCH FIRST 1 ROWS ONLY",
	        submittedId
	    );

	    if (existingReportId > 0) {
	        return new X_ZZ_WSP_ATR_Report(getCtx(), existingReportId, get_TrxName());
	    }

	    return null;
	}


	private void runProcessInBackgroundWithIntParam(String adProcessUU, String paramName, int paramValue, int recordIdForInstance) {
		MProcess proc = MProcess.get(ctx, adProcessUU);
		if (proc == null || proc.getAD_Process_ID() <= 0) throw new AdempiereException("Process not found (UU=" + adProcessUU + ")");

		ProcessInfo pi = new ProcessInfo(proc.getName(), proc.getAD_Process_ID());
		pi.setAD_User_ID(Env.getAD_User_ID(ctx));
		pi.setAD_Client_ID(Env.getAD_Client_ID(ctx));
		pi.setTable_ID(MTable.getTable_ID(X_ZZ_WSP_ATR_Report.Table_Name));
		pi.setRecord_ID(recordIdForInstance);
		pi.setAD_Process_UU(proc.getAD_Process_UU());

		MPInstance instance = new MPInstance(ctx, proc.getAD_Process_ID(), 0, recordIdForInstance, null);
		instance.setIsRunAsJob(true);
		instance.setNotificationType(MPInstance.NOTIFICATIONTYPE_EMailPlusNotice);
		instance.saveEx();

		pi.setAD_PInstance_ID(instance.getAD_PInstance_ID());

		Callback<Integer> createInstanceParaCallback = id -> {
			if (id > 0) {
				MPInstance instanceLater = new MPInstance(Env.getCtx(), id, null);
				MPInstancePara para = new MPInstancePara(instanceLater, 10);
				para.setParameterName(paramName);
				para.setP_Number(paramValue);
				para.saveEx();
			}
		};

		BackgroundJob.create(pi)
		.withContext(ctx)
		.withNotificationType(instance.getNotificationType())
		.withInitialDelay(250)
		.run(createInstanceParaCallback);
	}
}
